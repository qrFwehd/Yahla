<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure File Transfer v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary-color: #2ecc71;
            --background-color: #1a1a1a;
        }

        body {
            font-family: 'Tahoma', sans-serif;
            background: var(--background-color);
            color: #fff;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .security-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        #qrcode-container {
            margin: 20px auto;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            width: fit-content;
        }

        .otp-display {
            font-size: 2.5em;
            letter-spacing: 5px;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
        }

        .file-input-section {
            border: 2px dashed var(--primary-color);
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        #lang-switcher {
            position: fixed;
            bottom: 10px;
            left: 10px;
        }
    </style>
</head>
<body>
    <div class="security-badge">ğŸ”’ TLS 1.3 ENCRYPTED</div>
    
    <div id="admin-panel">
        <h1>ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¢Ù…Ù† v2.0</h1>
        
        <div id="qrcode-container"></div>
        
        <div class="otp-display" id="dynamic-code"></div>
        
        <div class="file-input-section">
            <input type="file" id="file-upload" multiple accept="image/*,application/pdf" hidden>
            <button onclick="document.getElementById('file-upload').click()">ğŸ“ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙØ§Øª</button>
            <button onclick="handleUpload()" style="margin-right: 10px;">ğŸ“¤ Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹</button>
            <div id="upload-status"></div>
        </div>
        
        <div id="received-files"></div>
    </div>

    <select id="lang-switcher" onchange="switchLanguage()">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
    </select>

    <script>
        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const DB_NAME = 'SecureFileDB_v2';
        const STORE_NAME = 'EncryptedStorage';
        let currentOTP = null;
        let dbInstance = null;
        let activeSession = null;

        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function initializeDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve();
                };

                request.onerror = (event) => {
                    reject('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                };
            });
        }

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ OTP
        function generateOTP() {
            currentOTP = Math.floor(100000 + Math.random() * 900000);
            document.getElementById('dynamic-code').textContent = currentOTP;
            new QRCode(document.getElementById('qrcode-container'), {
                text: `${window.location.href}#${currentOTP}`,
                width: 256,
                height: 256,
                colorDark: "#1a1a1a",
                correctLevel: QRCode.CorrectLevel.H
            });
            return currentOTP;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙØ¹
        async function handleUpload() {
            const files = document.getElementById('file-upload').files;
            if (files.length === 0) return;
            
            const transaction = dbInstance.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            Array.from(files).forEach(async (file) => {
                const fileBuffer = await file.arrayBuffer();
                const encryptedData = CryptoJS.AES.encrypt(
                    CryptoJS.lib.WordArray.create(fileBuffer),
                    currentOTP.toString()
                ).toString();
                
                store.add({
                    data: encryptedData,
                    filename: file.name,
                    type: file.type,
                    timestamp: new Date().toISOString()
                });
            });

            document.getElementById('upload-status').innerHTML = 
                `âœ… ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`;
            
            generateOTP(); // ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø¨Ø¹Ø¯ ÙƒÙ„ Ø±ÙØ¹
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©
        function switchLanguage() {
            const lang = document.getElementById('lang-switcher').value;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø©
        window.onload = async () => {
            await initializeDB();
            generateOTP();
            
            // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker Ù…Ø³Ø¬Ù„'))
                    .catch(err => console.error('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', err));
            }
        };
    </script>
</body>
</html>
